---
layout: post
title: "hyper-v ubuntu extend disc"
date: 2026-02-20 10:00:01
categories: [spark]
permalink: posts/2026-02-20/hyper-v-ubuntu/
published: true
---

<!-- TOC BEGIN -->
- [1. Про що цей блог](#p-1")
- [2. Перевірки та очищення існуючої файлової системи](#p-2)
- [3. Розширення диска](#p-3)
- [4. Як встановлювати великі пакети Python, щоб вони не з'їдали місце](#p-4)
- [5. Як обмежити логи Docker (Log Rotation)](#p-5)
<!-- TOC END -->

## <a name="p-1">1. Про що цей блог</a>

Останнійм часом дуже чсто використовую віртуалки hyper-V для тимчасових робіт. Це дозволяє мені ізолвати якусь розробку і встановити там якісь тестові елементи, а потім це видалити, практично безслідно.

Також, дуже часто корпоративні обмеження вплаивають на використання чи вивчення потрібних інструментів.
Тому, я часто використовую лінуксові віртуалки UBUNU.  Там мінімум адміністрування і максимум ефективності. Але є нюанс, коли встановлюєш віртуалку з "коробки" hyper-v виникає проблема з розміром жорсткого диску. Ці проблеми уже не перший раз, тому вирішив записати послідовність дій, щоб потім знову не шукати.


## <a name="p-2">2. Перевірки та очищення існуючої файлової системи</a>

2.1. Швидка перевірка: чи дійсно закінчилося місце?

Іноді проблема не у фізичному місці, а в inodes (кількості файлів). Виконуємо команду:

```bash

df -h   # Перевірити вільні Гб
df -i   # Перевірити вільні іноди
```

Якщо  /home заповнені на 100%, переходимо до розширення.


2.2. Очищення "сміття"

- **Крок 1**: Очищення "швидких" Гігабайтів

Перш ніж щось розширювати, видалимо сміття, яке точно там є:

- Очистити кеш пакетів APT:

```Bash

    sudo apt-get clean
```

- Видалити старі версії Snap-пакетів (вони часто займають багато місця):

```Bash

    set -e
    snap list --all | awk '/disabled/{print $1, $3}' |
        while read snapname revision; do
            sudo snap remove "$snapname" --revision="$revision"
        done
```

- Очистити логи системи, які могли роздутися:

```Bash

    sudo journalctl --vacuum-time=3d
```

- Очистити кеш pip:

```Bash

    pip cache purge
```

- Видалення зупинених контейнерів та "висячих" шарів Docker

Якщо є контейнери, які завершилися з помилкою (Exited 1). Вони займають місце, але не працюють

```bash
docker system prune
```
Це видалить усі зупинені контейнери, неробочі мережі та "висячі" (dangling) образи.

- Очищення логів Docker 

Oracle дуже полюбляє писати багато логів. Якщо контейнер колись працював довго, його лог-файл міг розростися до кількох гігабайт.
Перевірите розмір логів:

```bash
sudo du -sh /var/lib/docker/containers/*/*-json.log
```

Якщо бачиvh там великі файли, очистити їх можна командою:

```bash
sudo truncate -s 0 /var/lib/docker/containers/*/*-json.log

```

Якщо після очищення місця все одно мало, перевірити, куди поділися наші ГБ, яких не бачить графічний інтерфейс:

```Bash

sudo du -sh /* 2>/dev/null | sort -h
```
## <a name="p-3">3. Розширення диска</a>

Це робиться у два етапи: спочатку "надуваємо" віртуальний диск в Windows, потім розтягуємо файлову систему всередині Ubuntu.

3.1. Крок А: В Hyper-V (Windows)

- Вимкнути віртуальну машину.

- Зайти в Параметри (Settings) VM -> Hard Drive.

    Натиснути Edit -> Expand.

    Вказати новий розмір (наприклад, додати ще 20-40 ГБ).

3.2. Крок Б: В Ubuntu

Після запуску Ubuntu побачить нове місце, але не зможе його використовувати, поки ми не розширимо розділ.

- Встановити утиліту (якщо немає): 

```bash

sudo apt update && sudo apt install cloud-guest-utils

```

- Розширити розділ (зазвичай це /dev/sda та розділ 3 або 2 — перевірте через lsblk):

```bash

    sudo growpart /dev/sda 1
    sudo resize2fs /dev/sda1
```


## <a name="p-4">4. Як встановлювати великі пакети Python, щоб вони не з'їдали місце</a> 

При встановленні великих пакетів (TensorFlow, PyTorch) використовуйте --no-cache-dir, щоб pip не зберігав копію інсталятора, яка займає зайве місце:

```Bash

pip install --no-cache-dir torch torchvision

```

Окрім --no-cache-dir, великі пакети часто потребують багато місця в /tmp під час розпакування. Якщо /tmp малий, інсталяція впаде навіть при вільному /home.

Рішення: Можна вказати тимчасову папку прямо в домашній директорії:

```Bash

TMPDIR=~/pshdev/temp pip install --no-cache-dir ultralytics

```

## <a name="p-5">5. Як обмежити логи Docker (Log Rotation) </a>

За замовчуванням Docker зберігає лог-файли контейнерів необмежено довго, що призводить до накопичення сміття у /var/lib/docker.

### 5.1.  Спосіб 1: Глобальне налаштування для всіх нових контейнерів

Це найкращий варіант. Потрібно створити або змінити файл конфігурації демона Docker.

Відкрити файл конфігурації:

```Bash

    sudo nano /etc/docker/daemon.json

    Додаnb (або відредагуйте) наступні параметри:
```JSON

    {
      "log-driver": "json-file",
      "log-opts": {
        "max-size": "10m",
        "max-file": "3"
      }
    }
```

- max-size: максимальний розмір одного файлу логів (тут — 10 МБ).

- max-file: скільки файлів зберігати, перш ніж старі почнуть видалятися (тут — 3 файли).

- Перезапустити Docker:

```Bash

    sudo systemctl restart docker
```

### 5.2. Спосіб 2: Налаштування для конкретного контейнера (через Docker Compose)

Якщо ви запускаєте проєкт через docker-compose.yml, можна додати обмеження прямо в опис сервісу:

```YAML

services:
  app:
    image: my-app:latest
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

```